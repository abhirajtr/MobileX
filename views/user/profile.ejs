<%- include('../partials/user-header') %>
    <style>
        #wallet-container {
            max-width: 45rem;
            margin: 50px auto;
            padding: 5rem;
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .wallet-balance {
            margin-top: 1rem;
            font-size: 2rem;
            margin-bottom: 20px;
        }

        .add-balance-input {
            margin-bottom: 1rem;
            width: calc(100% - 100px);
            /* Adjust as needed */
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
        }

        .add-balance-btn {
            padding: 10px 20px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .add-balance-btn:hover {
            background-color: #0056b3;
        }
    </style>
    <style>
        .upload-text {
            visibility: hidden;
            height: 30px;
        }

        .img-avatar:hover+.upload-text {
            visibility: visible;
        }

        /* orders */
        .order-item {
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            margin-bottom: 10px;
            padding: 5px;
            background-color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .order-details {
            margin-bottom: 5px;
        }

        .order-id {
            font-size: 12px;
            font-weight: bold;
            color: #333;
        }

        .status {
            font-size: 12px;
            color: #28a745;
        }

        .product {
            font-size: 14px;
            color: #333;
        }

        .quantity,
        .total-amount {
            font-size: 14px;
            color: #666;
        }

        .cancel-btn {
            margin-top: auto;
            margin-bottom: auto;
        }

        .payment-method-img,
        .product-img {
            max-width: 40px;
            height: auto;
        }

        .cancel-btn {
            padding: 8px 16px;
            /* Padding for button */
            background-color: #dc3545;
            /* Red background color */
            color: #fff;
            /* White text color */
            border: none;
            /* Remove border */
            border-radius: 4px;
            /* Rounded corners */
            cursor: pointer;
            /* Pointer cursor on hover */
        }
    </style>
    <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="/" rel="nofollow">Home</a>
                    <span></span> Profile
                </div>
            </div>
        </div>
        <section class="pt-15 pb-150">
            <div class="container">
                <div class="row">
                    <div class="col-lg-12 m-auto">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="dashboard-menu">
                                    <ul class="nav flex-column" role="tablist">
                                        <li class="nav-item">
                                            <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab"
                                                href="#dashboard" role="tab" aria-controls="dashboard"
                                                aria-selected="false"><i
                                                    class="fi-rs-settings-sliders mr-10"></i>Dashboard</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#orders"
                                                role="tab" aria-controls="orders" aria-selected="false"><i
                                                    class="fi-rs-shopping-bag mr-10"></i>Orders</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="address-tab" data-bs-toggle="tab" href="#address"
                                                role="tab" aria-controls="address" aria-selected="true"><i
                                                    class="fi-rs-marker mr-10"></i>My Address</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="wallet-tab" data-bs-toggle="tab" href="#wallet"
                                                role="tab" aria-controls="wallet" aria-selected="true"><i
                                                    class="fi-rs-apps mr-10"></i>Wallet</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="walletHistory-tab" data-bs-toggle="tab"
                                                href="#walletHistory" role="tab" aria-controls="walletHistory"
                                                aria-selected="true"><i class="fi-rs-apps mr-10"></i>Wallet History</a>
                                        </li>
                                        <!-- <li class="nav-item">
                                            <a class="nav-link" id="account-detail-tab" data-bs-toggle="tab"
                                                href="#account-detail" role="tab" aria-controls="account-detail"
                                                aria-selected="true"><i class="fi-rs-user mr-10"></i>Account details</a>
                                        </li> -->
                                        <li class="nav-item">
                                            <a class="nav-link" id="referalCode" data-bs-toggle="tab" href="#referal"
                                                role="tab" aria-controls="referal" aria-selected="true"><i
                                                    class="fi-rs-user mr-10"></i>Referal</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" href="page-login-register.html"><i
                                                    class="fi-rs-sign-out mr-10"></i>Logout</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="tab-content dashboard-content">


                                    <div class="tab-pane fade show active" id="dashboard" role="tabpanel"
                                        aria-labelledby="dashboard-tab">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="mb-0">User Profile</h5>
                                            </div>
                                            <div class="card-body text-center">
                                                <img src="/assets/profile.png"
                                                    class="card-img-top rounded-circle mx-auto mt-3" alt="Profile Image"
                                                    style="width: 100px; height: 100px; object-fit: cover;">
                                                <div class="card-body text-center">
                                                    <h5 class="card-title">
                                                        <%= user.name %>
                                                    </h5>
                                                    <p class="card-text"><strong>Email:</strong>
                                                        <%= user.email %>
                                                    </p>
                                                    <p class="card-text"><strong>Account Id:</strong>
                                                        <%= user._id %>
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>



                                    <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="mb-0">Your Orders</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table">
                                                        <thead>
                                                            <tr>
                                                                <th>Order</th>
                                                                <th>Date</th>
                                                                <th>Status</th>
                                                                <th>Total</th>
                                                                <th>Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <% orders.forEach(o=> { %>
                                                                <tr>
                                                                    <td>#<%= o._id %>
                                                                    </td>
                                                                    <td>
                                                                        <%= new Date(o.createdAt).toLocaleString() %>
                                                                    </td>
                                                                    <td>
                                                                        <%= o.status %>
                                                                    </td>
                                                                    <td>₹<%= o.totalPrice %>
                                                                    </td>
                                                                    <td><a href="/order-details?id=<%= o._id %>"
                                                                            class="btn-small d-block">View</a></td>
                                                                </tr>
                                                                <% }) %>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>




                                    <div class="tab-pane fade" id="address" role="tabpanel"
                                        aria-labelledby="address-tab">
                                        <a href="/addNewAddress" class="btn btn-sm">Add new address</a>
                                        <div class="row mt-3">


                                            <% if (addresses && addresses.address && addresses.address.length> 0) { %>
                                                <% addresses.address.forEach(a=> { %>
                                                    <div class="col-lg-6 mb-3">
                                                        <div class="card mb-3 mb-lg-0">
                                                            <div class="card-header">
                                                                <h5 class="mb-0">
                                                                    <%= a.addressType %>
                                                                </h5>
                                                            </div>
                                                            <div class="card-body">
                                                                <address>
                                                                    <%= a.name %><br>
                                                                        <%= a.landmark %>, <%= a.city %>, <%= a.state %>
                                                                                    <%= a.pincode %><br>
                                                                                        Phone: <%= a.phone %><br>
                                                                                            Alt. Phone: <%= a.altPhone
                                                                                                %>
                                                                </address>
                                                                <!-- Add any additional address information here -->
                                                                <a href="/edit-address?id=<%= a._id %>"
                                                                    class="btn-small">Edit</a>
                                                                <a href="/delete-address?id=<%= a._id %>"
                                                                    class=" ml-5 btn-small text-danger">Delete</a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <% }); %>
                                                        <% } else { %>
                                                            <p>No addresses found.</p>
                                                            <% } %>

                                        </div>
                                    </div>

                                    <div class="tab-pane fade" id="wallet" role="tabpanel"
                                        aria-labelledby="account-detail-tab">


                                        <div id="wallet-container">
                                            <h2>Wallet Balance</h2>
                                            <div class="wallet-balance">
                                                Balance: &#8377;<%= user.walletBalance %>.00
                                                    <!-- Replace with dynamic balance -->
                                            </div>
                                            <div class="input-group">
                                                <input type="number" id="addBalanceInput" class="add-balance-input"
                                                    placeholder="Enter amount to add">
                                                <button id="addBalanceBtn" class="add-balance-btn">Add Balance</button>
                                            </div>
                                        </div>


                                    </div>
                                    <div class="tab-pane fade" id="walletHistory" role="tabpanel"
                                        aria-labelledby="orders-tab">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="mb-0">Wallet History</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table">
                                                        <thead>
                                                            <tr>
                                                                <th>Date and Time</th>
                                                                <th>Type</th>
                                                                <th>Description</th>
                                                                <th>Amount</th>
                                                                <th>Balance</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <%
                                                                user.walletHistory.sort((a, b)=> new Date(b.date) - new
                                                                Date(a.date));
                                                                user.walletHistory.forEach(w => {
                                                                %>
                                                                <tr>
                                                                    <td>
                                                                        <%= new Date(w.date).toLocaleString() %>
                                                                    </td>
                                                                    <td>
                                                                        <%= w.type %>
                                                                    </td>
                                                                    <td>
                                                                        <%= w.description %>
                                                                    </td>
                                                                    <td>
                                                                        <%= w.amount %>
                                                                    </td>
                                                                    <td>
                                                                        <%= w.balance %>
                                                                    </td>
                                                                </tr>
                                                                <% }) %>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="tab-pane fade" id="referal" role="tabpanel"
                                        aria-labelledby="track-orders-tab">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="mb-0">Referal Offer</h5>
                                            </div>
                                            <div class="card-body contact-from-area">

                                                <div class="row">
                                                    <div class="col-lg-8 mx-auto text-center mt-50">
                                                        <form onsubmit="redeemReferalCode(event)">
                                                            <div class="form-group">
                                                                <label for="walletAmount" class="h4">Your referal
                                                                    code</label>
                                                                <% if (locals.user.referralCode) { %>
                                                                    <br>
                                                                    <h5>
                                                                        <%= locals.user.referralCode %>
                                                                    </h5>
                                                                    <% }else{ %>
                                                                        <br>
                                                                        <h5>No referral code found</h5>
                                                                        <% } %>
                                                            </div>

                                                            <div class="mt-60">
                                                                <h5>Do you have a code?</h5>
                                                                <br>
                                                                <input class="border-1" id="referralInput" type="text"
                                                                    name="referralInput"
                                                                    style="border: 1px solid #000; width: 200px;">
                                                                <br><br>
                                                                <button type="submit">Get reward</button>
                                                            </div>

                                                        </form>
                                                    </div>
                                                </div>




                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
        </section>
    </main>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
        // $('document').ready(() => {
        //     const name = $('#name');
        //     const email = $('#email');
        //     $('#edit-details').submit(function (event) {
        //         event.preventDefault();
        //         const data = {
        //             name: $('#name').val().trim(),
        //             email: $('#email').val().trim()
        //         }
        //         if (isValidFomrm()) {
        //             $.ajax({
        //                 url: '/edit-details',
        //                 type: 'POST',
        //                 data: data,
        //                 success: function (response) {
        //                     $('#successMessage').text(response.message);
        //                     setTimeout(() => {
        //                         $('#successMessage').text('');
        //                         window.location.reload();
        //                     }, 2000)
        //                 }
        //             })
        //         }

        //     })
        //     function isValidFomrm() {
        //         if (name.val().trim() === '') {
        //             displayMessage('name', 'Plese enter your name');
        //             return false;
        //         }
        //         if (email.val().trim() === '') {
        //             displayMessage('email', 'Plese enter your email');
        //             return false;
        //         }
        //         return true;
        //     }
        //     function displayMessage(input, message) {
        //         $(`#${input}-error`).addClass('d-block').text(message);
        //         setTimeout(() => {
        //             $(`#${input}-error`).removeClass('d-block').text('');
        //         }, 3000)
        //     }
        // })
        
        function cancelOrder(button, orderId, productId) {
            console.log(button, orderId, productId);
            Swal.fire({
                title: "Are you sure?",
                text: "You won't be able to revert this!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes, cancel it!"
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/cancel-order',
                        method: 'POST',
                        data: { orderId, productId },
                        success: function (response) {
                            console.log(response);
                            // Create a new element for the "Cancelled" message
                            var cancelledMessage = $('<span/>')
                                .text('Cancelled')
                                .addClass('badge rounded-pill alert-danger');

                            // Replace the button with the "Cancelled" message
                            $(button).replaceWith(cancelledMessage);
                            $(`#status-${productId}`).text('cancelled');

                        }
                    })
                    Swal.fire({
                        title: "Cancelled!",
                        text: "Your order has been cancelled.",
                        icon: "success"

                    });

                }
            });
        }

        function returnOrder(button, orderId, productId, amount) {
            console.log(button, orderId, productId);
            Swal.fire({
                title: "Are you sure?",
                text: "You won't be able to revert this!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#3085d6",
                cancelButtonColor: "#d33",
                confirmButtonText: "Yes, cancel it!"
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/return-order',
                        method: 'POST',
                        data: { orderId, productId, amount },
                        success: function (response) {
                            console.log(response);
                            // Create a new element for the "Cancelled" message
                            var cancelledMessage = $('<span/>')
                                .text('returned')
                                .addClass('badge rounded-pill alert-danger');

                            // Replace the button with the "Cancelled" message
                            $(button).replaceWith(cancelledMessage);
                            $(`#status-${productId}`).text('returned');

                        }
                    })
                    Swal.fire({
                        title: "Returnded!",
                        text: "Your order has been returned.",
                        icon: "success"

                    });

                }
            });
        }


    </script>
    <script>
        $(document).ready(function () {
            $('#addBalanceBtn').on('click', function () {
                var addAmount = parseInt($('#addBalanceInput').val());
                // console.log(addAmount);
                if (isNaN(addAmount) || addAmount <= 0) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Invalid Amount',
                        text: 'Please enter a valid amount.'
                    });
                    return;
                }

                $.ajax({
                    url: '/add-wallet-balance',
                    method: 'POST',
                    data: { amount: addAmount },
                    success: function (response) {
                        console.log(response);

                        var options = {
                            "key": "rzp_test_2hyTCJ2qBkwleR", // Enter the Key ID generated from the Dashboard
                            // "amount": "5000", // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                            "currency": "INR",
                            "name": "MobileX",
                            "description": "Test Transaction",
                            "image": "https://example.com/your_logo",
                            "order_id": response.orderId, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                            // "callback_url": "https://eneqd3r9zrjok.x.pipedream.net/",
                            "prefill": {
                                "name": "Gaurav Kumar",
                                "email": "gaurav.kumar@example.com",
                                "contact": "9000090000"
                            },
                            "notes": {
                                "address": "Razorpay Corporate Office"
                            },
                            "handler": function (response) {
                                alert('Payment successful: ' + response.razorpay_payment_id);
                                var settings = {
                                    "url": "/verify-wallet-payment",
                                    "method": "POST",
                                    "timeout": 0,
                                    "headers": {
                                        "Content-Type": "application/json"
                                    },
                                    "data": JSON.stringify({ response, addAmount }),
                                    success: (response) => {
                                        console.log('updatedBalance', response);
                                        // if (response.redirect) {
                                        //     window.location.href = response.redirect;
                                        // }
                                        var updatedBalance = response.walletBalance;

                                        // Update the text content of the element with the class "wallet-balance"
                                        $('.wallet-balance').html('Balance: &#8377;' + updatedBalance.toFixed(2))
                                        // $('#wallet-balance').text('₹' + response.walletBalance);
                                    }
                                }
                                $.ajax(settings);
                            },
                            "theme": {
                                "color": "#3399cc"
                            }
                        };
                        console.log(response);
                        var rzp1 = new Razorpay(options);
                        rzp1.open();

                    }
                })


            });
        });
        // Referral Code
        let referralCodeAppled = false;
        function redeemReferalCode(event) {
            event.preventDefault();
            if (referralCodeAppled) {
                return errorSwal('Referral code already applied');
            }
            const inputElement = document.getElementById('referralInput');
            const referralCodeValue = inputElement.value;

            if (!referralCodeValue) {
                errorSwal('Please enter a referral code.')
            } else if (referralCodeValue.length !== 8) {
                errorSwal('Referral code must be exactly 8 characters long.')
            } else if (referralCodeValue == '<%= user.referralCode%>') {
                errorSwal('You cannot use your own referral code.');
            } else {
                const data = { referralCode: referralCodeValue }
                console.log(referralCodeValue);
                fetch('/redeem-referralCode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                    .then(response => {
                        return response.json();
                    })
                    .then(data => {
                        if (data.status) {
                            referralCodeAppled = true;
                            Swal.fire({
                                title: 'Success!',
                                text: data.message,
                                icon: 'success',
                                confirmButtonText: 'OK',
                            });
                        } else {
                            errorSwal(data.error);
                        }
                    })
            }
        }
        function errorSwal(text) {
            Swal.fire({
                title: 'Error!',
                text: text,
                icon: 'error',
                confirmButtonText: 'OK',
            });
        }
    </script>

    <%- include('../partials/user-footer') %>